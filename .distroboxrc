#!/bin/bash
# -----------------------------------------------------
# Distrobox Configuration
# -----------------------------------------------------
# This file runs when entering a distrobox container.
# It sets up symlinks and environment variables.
# All installations happen in create-devbox.sh

# -----------------------------------------------------
# Configuration & Paths
# -----------------------------------------------------
DOTFILES_DIR="$HOME/dotfiles"
DEV_CONFIG_DIR="$DOTFILES_DIR/.config/dev-env"
DEV_CONFIG_FILE="$DEV_CONFIG_DIR/config"

# Load cache partition config if exists
if [ -f "$DEV_CONFIG_FILE" ]; then
  source "$DEV_CONFIG_FILE"
fi

# -----------------------------------------------------
# Symlink Dotfiles
# -----------------------------------------------------
link_file() {
  local src="$1"
  local dest="$2"

  if [ -f "$src" ] || [ -d "$src" ]; then
    if [ ! -L "$dest" ]; then
      mkdir -p "$(dirname "$dest")"
      ln -sf "$src" "$dest"
    fi
  fi
}

link_file "$DOTFILES_DIR/.zshrc" "$HOME/.zshrc"
link_file "$DOTFILES_DIR/.config/zshrc" "$HOME/.config/zshrc"
link_file "$DOTFILES_DIR/.config/ohmyposh" "$HOME/.config/ohmyposh"
link_file "$DOTFILES_DIR/.local/bin/env" "$HOME/.local/bin/env"

# -----------------------------------------------------
# Configure dev tool caches on dev partition (for hard-linking)
# -----------------------------------------------------
if [ -n "$DEV_CACHE_PARTITION" ]; then
  # pnpm store
  if [ ! -f "$HOME/.pnpmrc" ]; then
    cat >"$HOME/.pnpmrc" <<EOF
store-dir=$DEV_CACHE_PARTITION/.pnpm-store
global-bin-dir=/usr/local/bin
EOF
  fi

  # uv cache
  export UV_CACHE_DIR="$DEV_CACHE_PARTITION/.uv-cache"
fi

# -----------------------------------------------------
# Environment Variables
# -----------------------------------------------------
export IN_DISTROBOX=1

if [ -n "$CONTAINER_ID" ]; then
  export DISTROBOX_NAME="$CONTAINER_ID"
else
  export DISTROBOX_NAME="$(awk -F'[=;]' '/name=/ {print $2}' /run/.containerenv 2>/dev/null || echo 'distrobox')"
fi
